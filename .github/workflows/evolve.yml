name: ğŸ§¬ Self-Healing Evolution

on:
  # Manual trigger button
  workflow_dispatch:
    inputs:
      test_value:
        description: 'Fibonacci input value to test'
        required: false
        default: '15'
  
  # Automatic trigger every 30 minutes
  schedule:
    - cron: '*/30 * * * *'  # Every 30 minutes

# Required permissions to commit changes
permissions:
  contents: write

jobs:
  evolve:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ğŸ“¦ Install Dependencies
        run: |
          pip install groq
      
      - name: ğŸ§¬ Run The Organism
        id: run_organism
        continue-on-error: true
        run: |
          echo "Running main.py..."
          python main.py 2> error.log
          echo "exit_code=$?" >> $GITHUB_OUTPUT
      
      - name: ğŸ“‹ Display Error Log (if failed)
        if: steps.run_organism.outcome == 'failure'
        run: |
          echo "ğŸ’€ Organism crashed! Error log:"
          cat error.log || echo "No error log generated"
      
      - name: ğŸ¥ Activate AI Doctor
        if: steps.run_organism.outcome == 'failure'
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          echo "ğŸ§¬ Initiating self-healing..."
          python healer.py
      
      - name: ğŸ’¾ Commit Healed Code
        if: steps.run_organism.outcome == 'failure'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ§¬ Auto-Evolution: Fixed Bug (Generation ${{ github.run_number }})"
          commit_author: "Ouroboros Bot <ouroboros@github-actions>"
          file_pattern: "main.py"
      
      - name: âœ… Success Report
        if: steps.run_organism.outcome == 'success'
        run: |
          echo "âœ… Organism is healthy and functioning!"
          echo "ğŸ§¬ No healing required this cycle."
      
      - name: ğŸ“Š Workflow Summary
        if: always()
        run: |
          echo "### ğŸ§¬ Evolution Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.run_organism.outcome }}" == "success" ]; then
            echo "**Status:** âœ… Healthy" >> $GITHUB_STEP_SUMMARY
            echo "**Action:** No healing required" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** ğŸ’€ Crashed â†’ ğŸ¥ Healed" >> $GITHUB_STEP_SUMMARY
            echo "**Action:** AI Doctor deployed fix" >> $GITHUB_STEP_SUMMARY
          fi
          echo "**Generation:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u)" >> $GITHUB_STEP_SUMMARY
